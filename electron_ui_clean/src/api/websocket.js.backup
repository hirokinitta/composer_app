// import { writable } from 'svelte/store';

// // -------------------------------------------------------------------
// // 1. WebSocket æ¥ç¶šã¨çŠ¶æ…‹ç®¡ç†ã®ãŸã‚ã®ã‚¹ãƒˆã‚¢å®šç¾©
// // -------------------------------------------------------------------

// // WebSocketã®æ¥ç¶šçŠ¶æ…‹
// export const wsStatus = writable('disconnected'); // 'connected', 'disconnected', 'error', 'connecting'

// // ãƒ‡ãƒƒã‚­ã¨ãƒŸã‚­ã‚µãƒ¼ã®æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
// // Goãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® GetStatus() ãŒè¿”ã™æ§‹é€ ä½“ã«åˆã‚ã›ã¾ã™
// const initialStatus = {
//     deckA: {
//         file: '',
//         playing: false,
//         position: 0,
//         duration: 0,
//         bpm: 0,
//         speed: 1.0,
//         volume: 1.0,
//         eq: { low: 0, mid: 0, high: 0 },
//         filter: { type: 'none', cutoff: 0, resonance: 0 },
//         loop: { enabled: false, start: 0, end: 0 },
//         cuePoints: []
//     },
//     deckB: {
//         file: '',
//         playing: false,
//         position: 0,
//         duration: 0,
//         bpm: 0,
//         speed: 1.0,
//         volume: 1.0,
//         eq: { low: 0, mid: 0, high: 0 },
//         filter: { type: 'none', cutoff: 0, resonance: 0 },
//         loop: { enabled: false, start: 0, end: 0 },
//         cuePoints: []
//     },
//     mixer: {
//         crossfader: 0.5,
//         masterVolume: 1.0,
//         syncEnabled: false,
//         syncMaster: '' // 'a' or 'b'
//     }
// };

// export const mixerStatus = writable(initialStatus);

// // -------------------------------------------------------------------
// // 2. WebSocket æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯
// // -------------------------------------------------------------------

// const WS_URL = 'ws://localhost:8080/ws/status';
// let ws = null;
// let reconnectInterval = 1000; // å†æ¥ç¶šè©¦è¡Œé–“éš” (ãƒŸãƒªç§’)

// /**
//  * WebSocketæ¥ç¶šã‚’ç¢ºç«‹ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ã‚¹ãƒˆã‚¢æ›´æ–°ã‚’è¨­å®šã™ã‚‹ã€‚
//  */
// function connect() {
//     if (ws && ws.readyState === WebSocket.OPEN) {
//         return;
//     }
    
//     wsStatus.set('connecting');
//     console.log('Attempting to connect to WebSocket...');

//     try {
//         ws = new WebSocket(WS_URL);
//     } catch (e) {
//         console.error('WebSocket creation failed:', e);
//         wsStatus.set('error');
//         scheduleReconnect();
//         return;
//     }

//     ws.onopen = () => {
//         console.log('âœ… WebSocket Connected!');
//         wsStatus.set('connected');
//         reconnectInterval = 1000; // æˆåŠŸã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
//     };

//     ws.onmessage = (event) => {
//         try {
//             const data = JSON.parse(event.data);
//             mixerStatus.set(data);
//         } catch (e) {
//             console.error('âŒ Error parsing WebSocket message:', e, event.data);
//         }
//     };

//     ws.onclose = () => {
//         console.log('ğŸ”Œ WebSocket Disconnected. Attempting reconnect...');
//         wsStatus.set('disconnected');
//         scheduleReconnect();
//     };

//     ws.onerror = (err) => {
//         console.error('âŒ WebSocket Error:', err);
//         wsStatus.set('error');
//         // onclose ã‚‚å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒå¤šã„ãŒã€å¿µã®ãŸã‚
//         if (ws.readyState !== WebSocket.OPEN && ws.readyState !== WebSocket.CONNECTING) {
//             scheduleReconnect();
//         }
//     };
// }

// /**
//  * å†æ¥ç¶šã‚’è©¦ã¿ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã™ã‚‹ã€‚
//  */
// function scheduleReconnect() {
//     if (wsStatus === 'connected' || wsStatus === 'connecting') {
//         return;
//     }
    
//     setTimeout(() => {
//         connect();
//     }, reconnectInterval);
    
//     // æœ€å¤§å†æ¥ç¶šé–“éš”ã‚’åˆ¶é™ (ä¾‹: 30ç§’)
//     reconnectInterval = Math.min(30000, reconnectInterval * 2);
// }

// /**
//  * å¤–éƒ¨ã‹ã‚‰æ¥ç¶šã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®é–¢æ•°ã€‚
//  */
// export function startWebSocketConnection() {
//     connect();
// }

// /**
//  * å¤–éƒ¨ã‹ã‚‰æ¥ç¶šã‚’é–‰ã˜ã‚‹ãŸã‚ã®é–¢æ•° (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ãªã©)ã€‚
//  */
// export function closeWebSocketConnection() {
//     if (ws) {
//         ws.close();
//         ws = null;
//     }
// }


import { writable } from 'svelte/store';

// æ¥ç¶šè¨­å®š
const WS_URL = 'ws://localhost:8080/ws/status'; // Goã‚µãƒ¼ãƒãƒ¼ã®WebSocketã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä»®å®š

/**
 * WebSocketæ¥ç¶šã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã‚¹ãƒˆã‚¢
 * 'disconnected', 'connecting', 'connected', 'error'
 */
export const wsStatus = writable('disconnected');

/**
 * Goãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å—ä¿¡ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒã™ã‚‹ã‚¹ãƒˆã‚¢
 */
export const mixerStatus = writable({
    deckA: {
        id: 'a',
        playing: false,
        cueEnabled: false, // ProMixerã®ãŸã‚ã«è¿½åŠ 
        gain: 1.0,          // ProMixerã®ãŸã‚ã«è¿½åŠ 
        pitch: 0.0,
        bpm: 128.0,
        trackInfo: null,
        currentTime: 0,
        totalTime: 0,
    },
    deckB: {
        id: 'b',
        playing: false,
        cueEnabled: false, // ProMixerã®ãŸã‚ã«è¿½åŠ 
        gain: 1.0,          // ProMixerã®ãŸã‚ã«è¿½åŠ 
        pitch: 0.0,
        bpm: 128.0,
        trackInfo: null,
        currentTime: 0,
        totalTime: 0,
    },
    mixer: {
        crossfader: 0.0, // -1.0 (A) to 1.0 (B)
        masterVolume: 1.0,
        syncEnabled: false,
        syncMaster: 'a',
    },
});

let ws;
let reconnectInterval = 1000;

/**
 * WebSocketæ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™ã€‚
 */
export function startWebSocketConnection() {
    // æ—¢å­˜ã®æ¥ç¶šãŒ OPEN ã§ã‚ã‚Œã°ã€ä½•ã‚‚ã—ãªã„
    if (ws && ws.readyState === WebSocket.OPEN) return;

    // ğŸ’¡ ä¿®æ­£: æ—¢å­˜ã®æ¥ç¶šãŒã‚ã‚‹å ´åˆã€å¼·åˆ¶çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã«é–‰ã˜ã‚‹
    // ã“ã‚Œã«ã‚ˆã‚Šã€å¤šé‡æ¥ç¶šã®è©¦è¡Œã‚’é˜²ã
    if (ws) {
        // CLOSEçŠ¶æ…‹ã§ã¯ãªã„å ´åˆã®ã¿é–‰ã˜ã‚‹ (ã‚¯ãƒªãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰1000ã§ onclose ãŒè‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ã‚ˆã†ã«)
        if (ws.readyState !== WebSocket.CLOSED) {
            console.log('Force closing previous WebSocket connection...');
            ws.close(1000, 'Reconnection attempt clean up'); 
        }
        ws = null; // æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    }


    wsStatus.set('connecting');
    console.log(`Attempting to connect to ${WS_URL}...`);

    try {
        ws = new WebSocket(WS_URL);
    } catch (e) {
        console.error('WebSocket creation failed:', e);
        wsStatus.set('error');
        // WebSocketã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆè‡ªä½“ãŒå¤±æ•—ã—ãŸå ´åˆã‚‚ãƒªãƒˆãƒ©ã‚¤
        setTimeout(startWebSocketConnection, reconnectInterval);
        reconnectInterval = Math.min(reconnectInterval * 2, 30000);
        return;
    }

    ws.onopen = () => {
        wsStatus.set('connected');
        console.log('WebSocket Connected successfully.');
        reconnectInterval = 1000; // æˆåŠŸã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            // ğŸ’¡ ä¿®æ­£ï¼šGoã‚µãƒ¼ãƒãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥é€ã£ã¦ãã‚‹ãŸã‚ã€
            // å‹ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã‹ã€ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã‚’è¦‹ã¦åˆ¤æ–­ã™ã‚‹
            if (data.deckA && data.deckB && data.mixer) {
                // ç”Ÿã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°
                mixerStatus.set(data);
                // console.log('Mixer status updated:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
            } else if (data.type === 'STATUS_UPDATE') {
                // å¿µã®ãŸã‚ã€ä»¥å‰ã®å½¢å¼ã‚‚å—ã‘å…¥ã‚Œå¯èƒ½ã«ã—ã¦ãŠã
                mixerStatus.set(data.payload);
            }
        } catch (e) {
            console.error('Error parsing WebSocket message:', e, event.data);
        }
    };

    ws.onclose = (event) => {
        if (event.wasClean) {
            console.log(`WebSocket closed cleanly, code=${event.code} reason=${event.reason}`);
        } else {
            // ã‚µãƒ¼ãƒãƒ¼ãƒ€ã‚¦ãƒ³ãªã©ã®ç•°å¸¸ãªåˆ‡æ–­
            console.error('WebSocket connection died. Retrying...');
        }
        wsStatus.set('disconnected');

        // è‡ªå‹•å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯
        setTimeout(startWebSocketConnection, reconnectInterval);
        reconnectInterval = Math.min(reconnectInterval * 2, 30000); // æŒ‡æ•°é–¢æ•°çš„ãªãƒãƒƒã‚¯ã‚ªãƒ•
    };

    ws.onerror = (error) => {
        console.error('WebSocket Error:', error);
        // ã‚¨ãƒ©ãƒ¼å¾Œã€oncloseãŒå‘¼ã°ã‚Œã€å†æ¥ç¶šãŒè©¦ã¿ã‚‰ã‚Œã¾ã™
        wsStatus.set('error');
    };
}

/**
 * WebSocketæ¥ç¶šã‚’é–‰ã˜ã¾ã™ã€‚
 */
export function closeWebSocketConnection() {
    if (ws) {
        // ws.onclose ãŒå†æ¥ç¶šã‚’è©¦ã¿ãªã„ã‚ˆã†ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçµ‚äº†ã‚³ãƒ¼ãƒ‰ã§é–‰ã˜ã‚‹
        ws.close(1000, 'Component destroyed');
        ws = null;
    }
}

/**
 * Goãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚
 * ç¾çŠ¶ã€APIã¯HTTPã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã®é–¢æ•°ã¯æœªä½¿ç”¨ã§ã™ãŒã€å°†æ¥çš„ã«å¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
 * @param {object} message - é€ä¿¡ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
// export function sendToBackend(message) {
//     if (ws && ws.readyState === WebSocket.OPEN) {
//         ws.send(JSON.stringify(message));
//     } else {
//         console.warn('WebSocket not open. Message not sent:', message);
//     }
// }