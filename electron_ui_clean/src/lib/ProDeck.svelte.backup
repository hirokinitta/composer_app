<script>
    import { onMount } from 'svelte';

    export let audioEngine;
    export let deck = 'a';
    export let deckInfo = {};
    export let onPlay = () => {};
    export let onPause = () => {};
    export let onStop = () => {};
    export let onVolumeChange = () => {};
    export let onSeek = () => {};
    export let onEQChange = () => {};
    export let onFilterChange = () => {};
    export let onSpeedChange = () => {};
    export let onAddCuePoint = () => {};
    export let onSetLoop = () => {};

    let electronAvailable = false;
    let loading = false;

    $: progress = deckInfo.duration > 0 ? (deckInfo.position / deckInfo.duration) * 100 : 0;
    $: fileName = deckInfo.file ? deckInfo.file.split(/[/\\]/).pop() : 'NO TRACK';
    $: pitchPercent = ((deckInfo.speed - 1.0) * 100).toFixed(1);
    $: deckColor = deck === 'a' ? '#00ff88' : '#ff0088';

    onMount(() => {
        // Electron API„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        electronAvailable = typeof window !== 'undefined' && 
                            window.electronAPI && 
                            typeof window.electronAPI.selectAudioFile === 'function';
        
        if (electronAvailable) {
            console.log('‚úÖ Electron API available for deck', deck);
        } else {
            console.warn('‚ö†Ô∏è Electron API not available - file loading disabled');
        }
    });

    async function handleLoadTrack() {
        if (!electronAvailable) {
            alert('Electron API not available. Make sure you are running in Electron.');
            return;
        }
        
        loading = true;
        try {
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åè
            const filePath = await window.electronAPI.selectAudioFile();
            
            if (!filePath) {
                console.log('No file selected');
                // loading = false;
                return;
            }
            
            console.log('‚úÖ Selected file:', filePath);

            // --- üö® ‰øÆÊ≠£ÁÇπ: HTTP (fetch) „ÅÆ‰ª£„Çè„Çä„Å´ AudioEngineClient (WebSocket) „Çí‰ΩøÁî® ---
            console.log(`üì§ Sending load command to Go backend for deck ${deck}: ${filePath}`);
            
            const url = `http://localhost:8080/api/deck/${deck}/load?file=${encodeURIComponent(filePath)}`;
            console.log('üì§ Sending load request to:', url);
            
            // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åçfetch
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                console.log('‚è±Ô∏è Request timeout after 30 seconds');
            }, 30000);
            
            try {
                const response = await fetch(url, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('üì• Response status:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('üì¶ Response data:', data);
                
                if (response.ok) {
                    console.log('‚úÖ Track loaded successfully:', data);
                    // deckInfo„ÅØË¶™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Åã„ÇâÊõ¥Êñ∞„Åï„Çå„ÇãÊÉ≥ÂÆö
                } else {
                    console.error('‚ùå Server error:', data.error);
                    alert(`Failed to load track: ${data.error || 'Unknown error'}`);
                }
            } catch (fetchError) {
                clearTimeout(timeoutId);
                
                if (fetchError.name === 'AbortError') {
                    console.error('‚ùå Load timeout (30 seconds)');
                    alert('Load timeout: The server took too long to respond. Check the Go server logs.');
                } else {
                    throw fetchError;
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading track:', error);
            alert(`Error: ${error.message}`);
        } finally {
            loading = false;
        }
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function handleEQChange(band, value) {
        const eq = { ...deckInfo.eq, [band]: parseFloat(value) };
        onEQChange(eq);
    }

    function handleSpeedChange(e) {
        const speed = parseFloat(e.target.value);
        onSpeedChange(speed);
    }

    function handleSeek(e) {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = x / rect.width;
        const newPos = percent * deckInfo.duration;
        onSeek(newPos);
    }

    function toggleLoop() {
        if (deckInfo.loop?.enabled) {
            // „É´„Éº„ÉóËß£Èô§
            onSetLoop(0, 0);
        } else {
            // ÁèæÂú®‰ΩçÁΩÆ„Åã„Çâ4ÊãçÂàÜ„ÅÆ„É´„Éº„Éó„ÇíË®≠ÂÆö
            const start = deckInfo.position;
            const beatsPerSecond = deckInfo.bpm / 60;
            const loopLength = 4 / beatsPerSecond; // 4ÊãçÂàÜ
            onSetLoop(start, start + loopLength);
        }
    }
</script>

<div class="pro-deck deck-{deck}">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="deck-header">
        <div class="deck-label" style="color: {deckColor}">
            DECK {deck.toUpperCase()}
        </div>
        <div class="bpm-display">
            {#if deckInfo.bpm > 0}
                <span class="bpm-value">{deckInfo.bpm.toFixed(1)}</span>
                <span class="bpm-label">BPM</span>
            {:else}
                <span class="bpm-label">-- BPM</span>
            {/if}
        </div>
    </div>

    <!-- „Éà„É©„ÉÉ„ÇØÊÉÖÂ†± -->
    <div class="track-info">
        <div class="track-name" title={deckInfo.file}>{fileName}</div>
        <button 
            class="load-btn" 
            on:click={handleLoadTrack}
            disabled={loading || !electronAvailable}
        >
            {#if loading}
                ‚è≥ LOADING...
            {:else if !electronAvailable}
                ‚ö†Ô∏è NO ELECTRON
            {:else}
                üìÅ LOAD
            {/if}
        </button>
    </div>

    <!-- Ê≥¢ÂΩ¢Ë°®Á§∫„Ç®„É™„Ç¢ -->
    <div class="waveform-container" on:click={handleSeek}>
        <div class="waveform-progress" style="width: {progress}%; background: {deckColor}"></div>
        <div class="playhead" style="left: {progress}%"></div>
        
        <!-- „Çø„Ç§„É†„Ç≥„Éº„Éâ -->
        <div class="timecode">
            <span class="time-current">{formatTime(deckInfo.position || 0)}</span>
            <span class="time-separator">/</span>
            <span class="time-total">{formatTime(deckInfo.duration || 0)}</span>
        </div>
    </div>

    <!-- „Éà„É©„É≥„Çπ„Éù„Éº„Éà„Ç≥„É≥„Éà„É≠„Éº„É´ -->
    <div class="transport">
        <button 
            class="transport-btn play" 
            class:active={deckInfo.playing}
            on:click={deckInfo.playing ? onPause : onPlay}
            disabled={!deckInfo.file}
        >
            {deckInfo.playing ? '‚è∏' : '‚ñ∂'}
        </button>
        <button 
            class="transport-btn stop" 
            on:click={onStop}
            disabled={!deckInfo.file}
        >
            ‚èπ
        </button>
        <button 
            class="transport-btn loop" 
            class:active={deckInfo.loop?.enabled}
            on:click={toggleLoop}
            disabled={!deckInfo.file}
        >
            üîÅ
        </button>
        <button 
            class="transport-btn cue" 
            on:click={() => onAddCuePoint(`Cue ${Date.now()}`, deckColor)}
            disabled={!deckInfo.file}
        >
            üìç
        </button>
    </div>

    <!-- „Éî„ÉÉ„ÉÅ„Ç≥„É≥„Éà„É≠„Éº„É´ -->
    <div class="pitch-control">
        <div class="pitch-label">PITCH</div>
        <input 
            type="range" 
            class="pitch-slider"
            min="0.8" 
            max="1.2" 
            step="0.001"
            value={deckInfo.speed || 1.0}
            on:input={handleSpeedChange}
            style="--thumb-color: {deckColor}"
            disabled={!deckInfo.file}
        />
        <div class="pitch-value" style="color: {deckColor}">
            {pitchPercent > 0 ? '+' : ''}{pitchPercent}%
        </div>
    </div>

    <!-- 3„Éê„É≥„ÉâEQ -->
    <div class="eq-section">
        <div class="eq-label">EQUALIZER</div>
        <div class="eq-controls">
            <div class="eq-knob">
                <input 
                    type="range" 
                    class="eq-slider"
                    min="-1" 
                    max="1" 
                    step="0.01"
                    value={deckInfo.eq?.high || 0}
                    on:input={(e) => handleEQChange('high', e.target.value)}
                    orient="vertical"
                    disabled={!deckInfo.file}
                />
                <span class="eq-label-text">HIGH</span>
            </div>
            <div class="eq-knob">
                <input 
                    type="range" 
                    class="eq-slider"
                    min="-1" 
                    max="1" 
                    step="0.01"
                    value={deckInfo.eq?.mid || 0}
                    on:input={(e) => handleEQChange('mid', e.target.value)}
                    orient="vertical"
                    disabled={!deckInfo.file}
                />
                <span class="eq-label-text">MID</span>
            </div>
            <div class="eq-knob">
                <input 
                    type="range" 
                    class="eq-slider"
                    min="-1" 
                    max="1" 
                    step="0.01"
                    value={deckInfo.eq?.low || 0}
                    on:input={(e) => handleEQChange('low', e.target.value)}
                    orient="vertical"
                    disabled={!deckInfo.file}
                />
                <span class="eq-label-text">LOW</span>
            </div>
        </div>
    </div>

    <!-- „Éú„É™„É•„Éº„É†„Éï„Çß„Éº„ÉÄ„Éº -->
    <div class="volume-fader">
        <div class="volume-label">VOLUME</div>
        <input 
            type="range" 
            class="volume-slider"
            min="0" 
            max="1" 
            step="0.01"
            value={deckInfo.volume || 1.0}
            on:input={(e) => onVolumeChange(parseFloat(e.target.value))}
            orient="vertical"
        />
        <div class="volume-meter">
            <div class="volume-fill" style="height: {(deckInfo.volume || 1.0) * 100}%; background: {deckColor}"></div>
        </div>
    </div>
</div>

<style>
    .pro-deck {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .deck-a {
        border-color: rgba(0, 255, 136, 0.3);
    }

    .deck-b {
        border-color: rgba(255, 0, 136, 0.3);
    }

    .deck-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .deck-label {
        font-size: 24px;
        font-weight: 900;
        letter-spacing: 2px;
        text-shadow: 0 0 20px currentColor;
    }

    .bpm-display {
        display: flex;
        align-items: baseline;
        gap: 5px;
    }

    .bpm-value {
        font-size: 32px;
        font-weight: 900;
        color: #fff;
        font-family: 'Courier New', monospace;
    }

    .bpm-label {
        font-size: 12px;
        color: #888;
        letter-spacing: 1px;
    }

    .track-info {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .track-name {
        flex: 1;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .load-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
    }

    .load-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
        transform: translateY(-2px);
    }

    .load-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .waveform-container {
        position: relative;
        height: 100px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .waveform-progress {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        opacity: 0.3;
        transition: width 0.1s linear;
    }

    .playhead {
        position: absolute;
        top: 0;
        width: 2px;
        height: 100%;
        background: #fff;
        box-shadow: 0 0 10px #fff;
        transition: left 0.1s linear;
    }

    .timecode {
        position: absolute;
        bottom: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
        font-family: 'Courier New', monospace;
        font-size: 18px;
        font-weight: 700;
        text-shadow: 0 0 5px #000;
    }

    .time-separator {
        color: #666;
    }

    .transport {
        display: flex;
        gap: 10px;
    }

    .transport-btn {
        flex: 1;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .transport-btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .transport-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: none;
    }

    .transport-btn.active {
        background: rgba(0, 255, 136, 0.2);
        border-color: #00ff88;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }

    .pitch-control {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .pitch-label {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1px;
        color: #888;
    }

    .pitch-slider {
        width: 100%;
        height: 40px;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        outline: none;
    }

    .pitch-slider:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .pitch-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 30px;
        height: 30px;
        background: var(--thumb-color, #00ff88);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 15px var(--thumb-color, #00ff88);
    }

    .pitch-value {
        font-size: 20px;
        font-weight: 900;
        text-align: center;
        font-family: 'Courier New', monospace;
    }

    .eq-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .eq-label {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1px;
        color: #888;
    }

    .eq-controls {
        display: flex;
        gap: 15px;
        justify-content: space-around;
    }

    .eq-knob {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .eq-slider {
        width: 40px;
        height: 120px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        writing-mode: vertical-lr;
        direction: rtl;
        -webkit-appearance: none;
        appearance: none;
    }

    .eq-slider:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .eq-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 30px;
        height: 30px;
        background: #00aaff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px #00aaff;
    }

    .eq-label-text {
        font-size: 11px;
        font-weight: 700;
        color: #888;
        letter-spacing: 1px;
    }

    .volume-fader {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        position: relative;
    }

    .volume-label {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1px;
        color: #888;
    }

    .volume-meter {
        width: 60px;
        height: 150px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 30px;
        position: relative;
        overflow: hidden;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .volume-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        transition: height 0.1s;
        box-shadow: 0 0 20px currentColor;
    }

    .volume-slider {
        position: absolute;
        width: 60px;
        height: 150px;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
        writing-mode: vertical-lr;
        direction: rtl;
        -webkit-appearance: none;
        appearance: none;
    }

    .volume-slider:disabled {
        cursor: not-allowed;
    }
</style>